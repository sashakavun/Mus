/* http://github.com/keta/mus */
(function(a,b,c){"use strict";var d=typeof module!=="undefined"&&module.exports||{};(function(a){function w(a,b,c){return v(a)(b,c)}function v(a,b){b=b||{};if(b.cache!==false){if(!t[a]){t[a]=s(a,b)}return t[a]}return s(a,b)}function u(){t={}}function s(a,b){var c="view,partials,stack,lookup,escapeHTML,renderSection,render";var d=r(a,b);var e=new Function(c,d);return function(c,d){d=d||{};var f=[c];try{return e(c,d,f,p,n,q,w)}catch(g){throw o(g.error,a,g.line,b.file)}}}function r(b,c){c=c||{};var d=c.tags||a.tags,e=d[0],f=d[d.length-1];var g=['var buffer = "";',"\nvar line = 1;","\ntry {",'\nbuffer += "'];var h=[],k=false,l=false;var m=function(){if(k&&!l&&!c.space){while(h.length){g.splice(h.pop(),1)}}else{h=[]}k=false;l=false};var n=[],p,q,r;var s=function(a){d=j(a).split(/\s+/);q=d[0];r=d[d.length-1]};var t=function(a){g.push('";',p,'\nvar partial = partials["'+j(a)+'"];',"\nif (partial) {","\n  buffer += render(partial,stack[stack.length - 1],partials);","\n}",'\nbuffer += "')};var u=function(a,d){var e=j(a);if(e===""){throw o(new Error("Section name may not be empty"),b,z,c.file)}n.push({name:e,inverted:d});g.push('";',p,'\nvar name = "'+e+'";',"\nvar callback = (function () {","\n  return function () {",'\n    var buffer = "";','\nbuffer += "')};var v=function(a){u(a,true)};var w=function(a){var d=j(a);var e=n.length!=0&&n[n.length-1].name;if(!e||d!=e){throw o(new Error('Section named "'+d+'" was never opened'),b,z,c.file)}var f=n.pop();g.push('";',"\n    return buffer;","\n  };","\n})();");if(f.inverted){g.push("\nbuffer += renderSection(name,stack,callback,true);")}else{g.push("\nbuffer += renderSection(name,stack,callback);")}g.push('\nbuffer += "')};var x=function(a){g.push('";',p,'\nbuffer += lookup("'+j(a)+'",stack,"");','\nbuffer += "')};var y=function(a){g.push('";',p,'\nbuffer += escapeHTML(lookup("'+j(a)+'",stack,""));','\nbuffer += "')};var z=1,A,B;for(var C=0,D=b.length;C<D;++C){if(b.slice(C,C+e.length)===e){C+=e.length;A=b.substr(C,1);p="\nline = "+z+";";q=e;r=f;k=true;switch(A){case"!":C++;B=null;break;case"=":C++;f="="+f;B=s;break;case">":C++;B=t;break;case"#":C++;B=u;break;case"^":C++;B=v;break;case"/":C++;B=w;break;case"{":f="}"+f;case"&":C++;l=true;B=x;break;default:l=true;B=y}var E=b.indexOf(f,C);if(E===-1){throw o(new Error('Tag "'+e+'" was not closed properly'),b,z,c.file)}var F=b.substring(C,E);if(B){B(F)}var G=0;while(~(G=F.indexOf("\n",G))){z++;G++}C=E+f.length-1;e=q;f=r}else{A=b.substr(C,1);switch(A){case'"':case"\\":l=true;g.push("\\"+A);break;case"\r":break;case"\n":h.push(g.length);g.push("\\n");m();z++;break;default:if(i(A)){h.push(g.length)}else{l=true}g.push(A)}}}if(n.length!=0){throw o(new Error('Section "'+n[n.length-1].name+'" was not closed properly'),b,z,c.file)}m();g.push('";',"\nreturn buffer;","\n} catch (e) { throw {error: e, line: line}; }");var H=g.join("").replace(/buffer \+= "";\n/g,"");if(c.debug){if(typeof console!="undefined"&&console.log){console.log(H)}else if(typeof print==="function"){print(H)}}return H}function q(a,b,c,d){var e="";var h=p(a,b);if(d){if(h==null||h===false||f(h)&&h.length===0){e+=c()}}else if(f(h)){g(h,function(a){b.push(a);e+=c();b.pop()})}else if(typeof h==="object"){b.push(h);e+=c();b.pop()}else if(typeof h==="function"){var i=b[b.length-1];var j=function(a){return w(a,i)};e+=h.call(i,c(),j)||""}else if(h){e+=c()}return e}function p(a,b,c){if(a==="."){return b[b.length-1]}var d=a.split(".");var e=d.length-1;var f=d[e];var g,h,i=b.length,j,k;while(i){k=b.slice(0);h=b[--i];j=0;while(j<e){h=h[d[j++]];if(h==null){break}k.push(h)}if(h&&typeof h==="object"&&f in h){g=h[f];break}}if(typeof g==="function"){g=g.call(k[k.length-1])}if(g==null){return c}return g}function o(a,b,c,d){d=d||"<template>";var e=b.split("\n"),f=Math.max(c-3,0),g=Math.min(e.length,c+3),h=e.slice(f,g);var i;for(var j=0,k=h.length;j<k;++j){i=j+f+1;h[j]=(i===c?" >> ":"    ")+h[j]}a.template=b;a.line=c;a.file=d;a.message=[d+":"+c,h.join("\n"),"",a.message].join("\n");return a}function n(a){return String(a).replace(/&(?!\w+;)|[<>"']/g,function(a){return m[a]||a})}function i(a){return h.test(a)}a.name="mustache.js";a.version="0.5.0-dev";a.tags=["{{","}}"];a.parse=r;a.compile=v;a.render=w;a.clearCache=u;a.to_html=function(a,b,c,d){var e=w(a,b,c);if(typeof d==="function"){d(e)}else{return e}};var b=Object.prototype.toString;var c=Array.isArray;var d=Array.prototype.forEach;var e=String.prototype.trim;var f;if(c){f=c}else{f=function(a){return b.call(a)==="[object Array]"}}var g;if(d){g=function(a,b,c){return d.call(a,b,c)}}else{g=function(a,b,c){for(var d=0,e=a.length;d<e;++d){b.call(c,a[d],d,a)}}}var h=/^\s*$/;var j;if(e){j=function(a){return a==null?"":e.call(a)}}else{var k,l;if(i("Â ")){k=/^\s+/;l=/\s+$/}else{k=/^[\s\xA0]+/;l=/[\s\xA0]+$/}j=function(a){return a==null?"":String(a).replace(k,"").replace(l,"")}}var m={"&":"&","<":"<",">":">",'"':""","'":"&#39;"};var t={}})(d);var e,f='script[type="text/x-mus"]';a.Mus=c.mus=e=function(a,b,c){if(e.hasOwnProperty(a)&&e.tpl.hasOwnProperty(a)){return e.execute(a,b,c)}throw new Error('Mus: "'+a+'" is incorrect template name.')};c.extend(e,{options:{prefix:"tpl"},helpers:{},partials:{},tpl:{},clear:function(){var a;for(a in e){if(e.hasOwnProperty(a)&&e.tpl.hasOwnProperty(a)){delete e[a];delete e.tpl[a]}}},set:function(a,b,f){if(e.hasOwnProperty(a)&&!e.tpl.hasOwnProperty(a)){throw new Error('Mus.set: "'+a+'" is incorrect template name.')}e[a]=e.tpl[a]=d.compile(b,c.extend({},e.options,f||{}));return e[a]},dom:function(a,b){var d=c(a||f),g=null,h=0,i=!e.options.space;if(e.options.prefix){g=new RegExp("^"+e.options.prefix);h=e.options.prefix.length}if(a!==f){d=d.filter(f)}d.each(function(a,d){var f=c(d),j=f.attr("id"),k=f.text();if(i){k=k.trim()}if(g&&j.length>h){j=j.replace(g,"");j=j.charAt(0).toLowerCase()+j.slice(1)}e.set(j,k,b)})},render:function(a,b,f,g,h){var i=c(a),j={name:b,el:i,data:f,partials:g};if(!i.length){throw new Error("Mus.render: target element not found.")}else if(typeof b!=="string"){throw new Error('Mus.render: "'+b+'" is incorrect template name.')}if(!e.hasOwnProperty(b)){if(!h){if(typeof g==="string"){h=g;j.partials=null}else if(typeof f==="string"){h=f;j.data={}}else if(e.options.url){h=e.options.url}else{throw new Error("Mus.render: template not found: "+b+" (auto-load disabled).")}}c.ajax({accepts:"text/x-mus",url:d.render(h,{name:b})}).success(function(a){return function(b){a.el.html(e.set(a.name,b)(a.name,a.data,a.partials))}}(j))}else if(e.tpl.hasOwnProperty(b)){i.html(e.execute(b,f,g));return true}return false},execute:function(a,b,d){return e[a](c.extend({},e.helpers,b||{}),c.extend({},e.partials,d||{}))}});c.fn.mus=function(a,b,c,d){e.render(this,a,b,c,d);return this};c(b).ready(function(){e.dom(f)})})(window,document,jQuery);
